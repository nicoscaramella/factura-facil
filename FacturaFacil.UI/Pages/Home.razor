@page "/"
@using FacturaFacil.Core
@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Components.WebAssembly.Hosting
@inject HttpClient Http
@inject IJSRuntime JS
@inject ILocalStorageService LocalStorage
@inject IWebAssemblyHostEnvironment HostEnvironment

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h5" GutterBottom="true">Generar Factura</MudText>
                
                <MudSwitch @bind-Value="invoice.IsAfipEnabled" Label="@(invoice.IsAfipEnabled ? "Factura Fiscal (AFIP)" : "Presupuesto / No Fiscal")" Color="Color.Success" Class="mb-4" />

                <MudForm @ref="form" @bind-IsValid="@success">
                    <MudGrid>
                        <MudItem xs="4">
                            <MudTextField T="int" Label="Punto de Venta" @bind-Value="invoice.PointOfSale" Required="true" />
                        </MudItem>
                        <MudItem xs="4">
                            <MudTextField T="int" Label="Número" @bind-Value="invoice.InvoiceNumber" Required="true" />
                        </MudItem>
                        <MudItem xs="4">
                            <MudSelect T="int" Label="Tipo" @bind-Value="invoice.InvoiceType" Required="true">
                                <MudSelectItem Value="@(11)">Factura C</MudSelectItem>
                                <MudSelectItem Value="@(1)">Factura A</MudSelectItem>
                                <MudSelectItem Value="@(6)">Factura B</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudDatePicker Label="Fecha de Emisión" @bind-Date="issueDate" />
                        </MudItem>
                        <MudItem xs="6" Class="d-flex align-center">
                            <MudSwitch @bind-Value="invoice.IncludeVat" Label="Agregar IVA (21%)" Color="Color.Primary" Disabled="@(invoice.InvoiceType != 1 && invoice.InvoiceType != 6)" />
                        </MudItem>
                        
                        <MudItem xs="12">
                            <MudText Typo="Typo.h6">Vendedor</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField T="string" Label="Nombre" @bind-Value="invoice.Seller.Name" Required="true" Placeholder="Ej: Mi Empresa S.A." />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField T="string" Label="CUIT" @bind-Value="invoice.Seller.TaxId" Required="true" Placeholder="Ej: 30123456789" MaxLength="11" HelperText="Solo 11 números" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField T="string" Label="Dirección" @bind-Value="invoice.Seller.Address" Placeholder="Ej: Calle Falsa 123" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudText Typo="Typo.h6">Comprador</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField T="string" Label="Nombre" @bind-Value="invoice.Buyer.Name" Required="true" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField T="string" Label="CUIT" @bind-Value="invoice.Buyer.TaxId" MaxLength="11" HelperText="Solo 11 números" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField T="string" Label="Dirección" @bind-Value="invoice.Buyer.Address" />
                        </MudItem>

                        <MudItem xs="12">
                            <div class="d-flex align-center justify-space-between">
                                <MudText Typo="Typo.h6">Items</MudText>
                                <MudButton OnClick="AddItem" Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add">Agregar Item</MudButton>
                            </div>
                        </MudItem>

                        @foreach (var item in invoice.Item)
                        {
                            <MudItem xs="12" md="6">
                                <MudTextField T="string" Label="Descripción" @bind-Value="item.Description" Required="true" />
                            </MudItem>
                            <MudItem xs="4" md="2">
                                <MudNumericField T="int" Label="Cant" @bind-Value="item.Quantity" Required="true" />
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudNumericField T="decimal" Label="Precio" @bind-Value="item.UnitPrice" Required="true" />
                            </MudItem>
                            <MudItem xs="2" md="1" Class="d-flex align-center">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveItem(item))" Disabled="@(invoice.Item.Count <= 1)" />
                            </MudItem>
                        }

                        <MudItem xs="12" Class="d-flex justify-end mt-4 gap-4">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GenerateInvoice" Disabled="@(!success || isGenerating)" Size="Size.Large">
                                @(isGenerating ? "Generando..." : "Visualizar PDF")
                            </MudButton>
                            @if (!string.IsNullOrEmpty(pdfUrl))
                            {
                                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="DownloadPdf" StartIcon="@Icons.Material.Filled.Download" Size="Size.Large">
                                    Descargar
                                </MudButton>
                            }
                        </MudItem>
                    </MudGrid>
                </MudForm>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Style="height: 800px; display: flex; flex-direction: column;">
                <MudText Typo="Typo.h5" GutterBottom="true">Vista Previa</MudText>
                @if (!string.IsNullOrEmpty(pdfUrl))
                {
                    <iframe src="@pdfUrl" style="width: 100%; flex-grow: 1; border: none;"></iframe>
                }
                else
                {
                    <div class="d-flex align-center justify-center" style="flex-grow: 1; border: 2px dashed var(--mud-palette-divider);">
                        <MudText Typo="Typo.body1" Color="Color.Secondary">La factura aparecerá aquí después de generarla.</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private MudForm form = null!;
    private bool success;
    private bool isGenerating;
    private string? pdfUrl;
    private DateTime? issueDate = DateTime.Today;
    private byte[]? pdfBytes;

    private InvoiceModel invoice = new InvoiceModel
    {
        PointOfSale = 1,
        InvoiceNumber = 1,
        InvoiceType = 11,
        Seller = new CompanyInfo(),
        Buyer = new CompanyInfo(),
        Item = new List<InvoiceItem> { new InvoiceItem { Description = "Servicios Profesionales", Quantity = 1, UnitPrice = 1000 } }
    };

    private void AddItem()
    {
        invoice.Item.Add(new InvoiceItem());
    }

    private void RemoveItem(InvoiceItem item)
    {
        if (invoice.Item.Count > 1)
        {
            invoice.Item.Remove(item);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // 1. Force Date to Today (ignoring previous state if any)
        issueDate = DateTime.Today;
        
        // 2. Load Seller Info from LocalStorage
        var savedSeller = await LocalStorage.GetItemAsync<CompanyInfo>("SellerInfo");
        if (savedSeller != null)
        {
            invoice.Seller = savedSeller;
        }

        // 3. Load Next Invoice Number
        var nextNumber = await LocalStorage.GetItemAsync<int>("NextInvoiceNumber");
        if (nextNumber > 0)
        {
            invoice.InvoiceNumber = nextNumber;
        }
    }

    private async Task GenerateInvoice()
    {
        isGenerating = true;
        invoice.IssueDate = issueDate ?? DateTime.Today;
        invoice.DueDate = invoice.IssueDate.AddDays(30);
        
        if (invoice.IsAfipEnabled)
        {
            invoice.CaeNumber = "74125896301236";
            invoice.CaeDueDate = DateTime.Today.AddDays(15);
        }
        else
        {
            invoice.CaeNumber = string.Empty;
            invoice.CaeDueDate = DateTime.MinValue;
        }

        try
        {
            // Save Seller Info for next time
            await LocalStorage.SetItemAsync("SellerInfo", invoice.Seller);

            // Al usar Nginx en el VPS, usamos ruta relativa. Nginx redirige internamente.
            string apiUrl = "api/invoices";

            var response = await Http.PostAsJsonAsync(apiUrl, invoice);
            if (response.IsSuccessStatusCode)
            {
                pdfBytes = await response.Content.ReadAsByteArrayAsync();
                var base64 = Convert.ToBase64String(pdfBytes);
                pdfUrl = $"data:application/pdf;base64,{base64}";
                
                // Increment number for next invoice and save
                invoice.InvoiceNumber++;
                await LocalStorage.SetItemAsync("NextInvoiceNumber", invoice.InvoiceNumber);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error generating invoice: {ex.Message}");
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task DownloadPdf()
    {
        if (!string.IsNullOrEmpty(pdfUrl))
        {
            await JS.InvokeVoidAsync("downloadFromUrl", $"Factura-{invoice.InvoiceNumber}.pdf", pdfUrl);
        }
    }
}