<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FacturaFacil.UI</title>
    <base href="/" />
    <link rel="preload" id="webassembly" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="FacturaFacil.UI.styles.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel=
    "stylesheet"/>
    <link href="_content/MudBlazor/MudBlazor.min.css" rel="stylesheet" />
    <script type="importmap"></script>
</head>

<body>
    <div id="app">
        <style>
            .app-loading {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh;
                background-color: #f5f5f5;
                font-family: 'Roboto', sans-serif;
            }
            .app-logo-text {
                font-size: 2.5rem;
                font-weight: 300;
                color: #594ae2; /* MudBlazor Primary Color */
                margin-bottom: 20px;
            }
            .spinner {
                width: 50px;
                height: 50px;
                border: 5px solid #e0e0e0;
                border-top: 5px solid #594ae2;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            .loading-text {
                margin-top: 15px;
                color: #757575;
                font-size: 0.9rem;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
        <div class="app-loading">
            <div class="app-logo-text">Factura F谩cil</div>
            <div class="spinner"></div>
            <div class="loading-progress-text loading-text">Iniciando...</div>
        </div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss"></span>
    </div>

    <script>
        function logProgress(message) {
            console.log('[Setup] ' + message);
            const el = document.querySelector('.loading-progress-text');
            if (el) el.innerText = message;
        }

        logProgress('Inicializando entorno...');

        window.addEventListener('error', function(event) {
            console.error('Global Error:', event.error);
            const errorUi = document.getElementById('blazor-error-ui');
            if (errorUi) {
                errorUi.style.display = 'block';
                errorUi.innerText = 'Error Cr铆tico: ' + (event.error?.message || event.message || 'Error desconocido');
            }
            logProgress('DETENIDO: Error cr铆tico detectado.');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled Rejection:', event.reason);
            const errorUi = document.getElementById('blazor-error-ui');
            if (errorUi) {
                errorUi.style.display = 'block';
                errorUi.innerText = 'Error Promesa: ' + (event.reason?.message || event.reason || 'Rechazo desconocido');
            }
             logProgress('DETENIDO: Promesa rechazada.');
        });

        // Configuraci贸n de Blazor para interceptar la carga
        window.Blazor = {
            loadBootResource: function (type, name, defaultUri, integrity) {
                logProgress(`Cargando: ${name} (${type})...`);
                // Retornar la URI por defecto permite que la carga contin煤e
                return defaultUri;
            }
        };
    </script>
    <script type="module">
        logProgress('Importando motor Blazor WebAssembly...');
        try {
            const result = await import('./_framework/blazor.webassembly.js');
            logProgress('Motor importado. Ejecutando arranque manual...');
            
            // En .NET 8/9/10, si se carga como m贸dulo, a veces start no es default export.
            // Pero window.Blazor se define globalmente como efecto secundario.
            if (window.Blazor && typeof window.Blazor.start === 'function') {
                await window.Blazor.start();
                logProgress('Aplicaci贸n iniciada exitosamente.');
            } else if (result && typeof result.start === 'function') {
                await result.start();
                logProgress('Aplicaci贸n iniciada via export.');
            } else {
                throw new Error("No se encontr贸 la funci贸n start() en window.Blazor ni en el m贸dulo exportado.");
            }

        } catch (e) {
            logProgress('FALLO CRTICO al iniciar: ' + e);
            console.error(e);
            const errorUi = document.getElementById('blazor-error-ui');
            if (errorUi) {
                errorUi.style.display = 'block';
                errorUi.innerText = 'Error fatal: ' + e;
            }
        }
    </script>
    <script src="_content/MudBlazor/MudBlazor.min.js"></script>
    <script>
        window.downloadFromUrl = (fileName, url) => {
            const anchorElement = document.createElement('a');
            anchorElement.href = url;
            anchorElement.download = fileName ?? 'factura.pdf';
            anchorElement.click();
            anchorElement.remove();
        }
    </script>
</body>

</html>
